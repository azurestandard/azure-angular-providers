<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8"/>
		<title>Azure Standard AngularJS Providers</title>
	</head>
	<body ng-app="AzureApp" ng-controller="AzureCtrl">
		<h1>Azure Standard AngularJS Providers</h1>

		<div ng-if="session.person">
			<p>Hello {{person.name}},</p>
			<div ng-if="favorites.length">
				<p>
					You have {{favorites_count.count}} favorites. The first
					{{favorites.length}} are:
				</p>
				<table>
					<thead>
						<th>Code</th>
						<th>Name</th>
						<th>Packaging</th>
						<th>Categories</th>
					</thead>
					<tbody>
						<tr ng-repeat="product in favorites">
							<td>{{product.product.code}}</td>
							<td>{{product.product.name}}</td>
							<td>
								<select ng-if="product.products"
								        ng-options="prod.code as productPackagingLabel(prod) for prod in product.products"
								        ng-model="product.code"
								        ng-change="product.selectPackaging(product.code)" />
							</td>
							<td>
								<ul ng-if="product.categories().length">
									<li ng-repeat="category in product.categories()">
										<span ng-repeat="cat in category.ancestors.slice().reverse()"
										      title="id: {{cat.id}}, path: {{category.path(cat)}}">
											{{cat.name}}
											<span ng-if="!$last">→</span>
										</span>
									</li>
								<ul>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
		<div ng-if="!session.person">
			<p>You're in an anonymous session.</p>
			<form ng-submit="login()" ng-controller="LoginCtrl">
				<input type="text" ng-model="credentials.username"
				       placeholder="username or email" /><br />
				<input type="password" ng-model="credentials.password"
				       placeholder="password" /><br />
				<input type="submit" value="Login" />
				<p ng-if="warning" class="warning">{{warning}}</p>
			</form>
		</div>

		<p ng-if="!carts.carts.length">You don't have any carts.</p>
		<div ng-if="carts.carts.length">
			<p>You have {{carts.carts.length}} carts. They are:</p>
			<table>
				<thead>
					<th>ID</th>
					<th>Drop</th>
					<th>Trip</th>
					<th>Lines</th>
					<th>Products</th>
					<th>Weight</th>
					<th>Price</th>
				</thead>
				<tbody>
					<tr ng-repeat="cart in carts.carts">
						<td>
							<button ng-click="carts.selectCart(cart.order.id)"
							        title="select as the primary cart">
								{{cart.order.id}}
							</button>
						</td>
						<td>{{cart.drop.name}}</td>
						<td>{{cart.trip.route}} - {{cart.trip.cutoff}}</td>
						<td>
							<table>
								<thead>
									<tr>
										<th>Product</th>
										<th>Requested</th>
										<th>Delete</td>
									</tr>
								</thead>
								<tbody>
									<tr ng-repeat="line in cart.orderLines">
										<td>
											{{line.orderLine.product}}
										</td>
										<td>
											<form>
												<input type="number"
												       ng-model="line.orderLine['quantity-ordered']"
												       ng-model-options="{updateOn: 'blur'}"
												       ng-change="line.save()"
												       min="0" step="1" required="" />
											</form>
										</td>
										<td>
											<a class="btn" ng-click="line.delete()"
											   title="delete order-line {{line.id}}">
												x
											</a>
										</td>
									</tr>
								</tbody>
							</table>
						</td>
						<td>{{cart.products}}</td>
						<td>{{cart.weight}}</td>
						<td>{{cart.price}}</td>
					</tr>
				</tbody>
			</table>
			<p>Your primary cart is {{carts.cart.order.id}}.</p>
			<form ng-submit="add()" ng-controller="OrderLineCreate">
				<p>Add an order line:</p>
				<input type="text" ng-model="line.product"
				       placeholder="product code" /><br />
				<input type="number" ng-model="line['quantity-ordered']"
				       placeholder="quantity" /><br />
				<input type="submit" value="Add to cart" />
				<p ng-if="warning" class="warning">{{warning}}</p>
			</form>
		</div>

		<form ng-controller="CategoryByPathCtrl">
			<p>Category lookup by path.</p>
			<p>
				Path:
				<input type="text" ng-model="path" ng-trim="true" size="80"
				       ng-change="getCategory()" />
			</p>
			<p ng-if="warning" class="warning">{{warning}}</p>
			<p ng-if="category.ancestors.length">
				<span ng-repeat="cat in category.ancestors.slice().reverse()"
				      title="id: {{cat.id}}, path: {{category.path(cat)}}">
					{{cat.name}}
					<span ng-if="!$last">→</span>
				</span>
			</p>
		</form>

		<div ng-if="category.children().length">
			<p>First two category levels:</p>
			<ul>
				<li ng-repeat="cat in category.children()"
				    title="id: {{cat.category.id}}">
					{{cat.category.name}}
					<ul>
						<li ng-repeat="c in cat.children()"
								title="id: {{c.category.id}}">
							{{c.category.name}}
						</li>
					</ul>
				</li>
		</div>

		<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.3.0/angular.min.js"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.3.0/angular-resource.min.js"></script>
		<script src="azure-providers.js"></script>
		<script type="text/javascript">
			angular.module('AzureApp', ['azureProviders'])
				.controller(
					'AzureCtrl',
					['$rootScope', '$scope', 'AzureAPI', 'AzureCarts', 'AzureCategory', 'AzureProduct',
					function($rootScope, $scope, AzureAPI, AzureCarts, AzureCategory, AzureProduct) {
						$scope.category = new AzureCategory(null);
						$rootScope.setupPerson = function(person) {
							$scope.person = person;
							$scope.session = AzureAPI.session.get();
							$scope.carts = new AzureCarts(person.id);
							$scope.favorites_count = AzureAPI.product.count({
								person: person.id,
							});
							$scope.favorites = [];
							AzureAPI.product.query({
								person: person.id,
								limit: 3,
							}).$promise.then(function(products) {
								products.forEach(function(product) {
									$scope.favorites.push(new AzureProduct(product.code));
								});
							});
						};
						$scope.session = AzureAPI.session.get();
						$scope.session.$promise.then(function(session) {
							if (session.person) {
								AzureAPI.person.get().$promise.then(function(person) {
									$rootScope.setupPerson(person);
								});
							} /* else {
								TODO: anonymous carts
								$scope.carts = new AzureCarts();
							} */
						});
						$scope.productPackagingLabel = function(product) {
							return product.code + ' (' + product.size + ', $' + product.price.dollars + ')';
						};
					}])
				.controller(
					'OrderLineCreate',
					['$scope', '$timeout', 'AzureAPI',
					function($scope, $timeout, AzureAPI) {
						$scope.line = {
							'product': null,
							'quantity-ordered': 1,
						};
						$scope.warning = null;
						$scope.add = function() {
							$scope.warning = null;
							$scope.line.order = $scope.carts.cart.order.id;
							AzureAPI['order-line'].create($scope.line,
								function() {},  /* no-op success handler */
								function(response) {
									if (response.status === 400) {
										$scope.warning = response.data.message;
										$timeout(function() {$scope.warning = null;}, 5000);
									}
								}
							);
						};
					}])
				.controller(
					'LoginCtrl',
					['$rootScope', '$scope', '$timeout', 'AzureAPI',
					function($rootScope, $scope, $timeout, AzureAPI) {
						$scope.credentials = {
							username: null,
							password: null,
						};
						$scope.warning = null;
						$scope.login = function() {
							$scope.warning = null;
							AzureAPI.login(
								$scope.credentials.username,
								$scope.credentials.password
							).success(function(data) {
								$rootScope.setupPerson(data);
							}).error(function(data, status) {
								$scope.warning = 'unable to authenticate';
								$timeout(function() {$scope.warning = null;}, 5000);
							});
						};
					}])
				.controller(
					'CategoryByPathCtrl',
					['$scope', '$timeout', 'AzureCategory',
					function($scope, $timeout, AzureCategory) {
						$scope.path = null;
						$scope.warning = null;
						$scope.getCategory = function() {
							var x = AzureCategory($scope.path).then(function(category) {
								$scope.category = category;
							}, function(reason) {
								$scope.warning = reason;
								$scope.category = null;
								$timeout(function() {$scope.warning = null;}, 5000);
							});
						};
					}]);
		</script>
		<style>
			.warning {
				color: red;
			}
			.btn {
				border-radius: 2px;
				background-color: #99f;
				padding-right: 0.5em;
				padding-left: 0.5em;
				cursor: pointer;
			}
			.btn:hover {
				background-color: #aaf;
			}
		</style>
	</body>
</html>
